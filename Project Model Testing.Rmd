---
title: "Exploratory Data Analysis"
output: 
  html_document:
    code_folding:
      hide
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r Libraries}
library(tidyverse)
library(readxl)
library(ggforce)
library(concaveman)
library(knitr)
library(olsrr)
library(ranger)
library(Metrics)
library(mgcv)
library(caret)
library(patchwork)
library(glmnet)
library(broom)
library(RColorBrewer)

options(scipen = 999)
set.seed(3630)
```

``` {r Functions}
# Strike Zone GG Object
geom_zone <- function(top = 11/3, bottom = 3/2, linecolor = "black"){
  geom_rect(xmin = -.7083, xmax = .7083, ymin = bottom, ymax = top,
            alpha = 0, color = linecolor, linewidth = 0.75)
}

# c(0, 0, -.25, -.5, -.25))

# Home Plate GG Object
geom_plate <- function(pov = "pitcher"){
  df <- case_when(
    pov == "pitcher" ~ 
      data.frame(x = c(-.7083, .7083, .7083 ,0, -.7083), y = c(0, 0, .25, .5, .25)),
    pov == "catcher" ~ 
      data.frame(x = c(-.7083, .7083, .7083 ,0, -.7083), y = c(0, 0, -.25, -.5, -.25))
  )
  
  g <- geom_polygon(data = df, aes(x = x, y = y), fill = "white", color = "black", linewidth = 1.25)
  g
}

# Barrel Function
is.barrel <- function(LA, EV){
  upper <- 1.11*EV - 78.89
  lower <- -EV + 124
  outcome <- (LA >= lower) & (LA <= upper) & (EV >= 98) & (LA >= 8) & (LA <= 50)
  outcome <- replace_na(outcome, FALSE)
  outcome
}

# Normal Name Changer
swap_names <- function(name) {
  parts <- strsplit(name, ", ")[[1]]
  if (length(parts) == 2) {
    return(paste(rev(parts), collapse = " "))
  } else {
    return(name)
  }
}
```


```{r}

seasonal <- read_csv("CSVs/season_stats.csv")

pitchers <- read_csv("CSVs/pitcher_comps.csv")

arsenal <- read_csv("CSVs/arsenal.csv")

empty <- read_csv("CSVs/bases_empty.csv")

whiff <- pitchers %>% 
  mutate(whiff = description == "swinging_strike",
         whiff = as.character(whiff)) %>% 
  filter(pitch_type != "NA",
         pitch_type != "PO")

LHP <- read_csv("CSVs/lhp_pitches.csv") %>% 
  select(-...1) %>% 
  filter(!is.na(pitch_type)) %>% 
  mutate(pitch_type = str_replace(pitch_type, "CS", "CU"),
         pitch_name = str_replace(pitch_name, "Slow Curve", "Curveball"),
         pitch_type = str_replace(pitch_type, "KC", "CU"),
         pitch_name = str_replace(pitch_name, "Knuckle Curve", "Curveball"))

RHP <- read_csv("CSVs/rhp_pitches.csv") %>% 
  select(-...1)


whiff_l <- LHP %>% 
  mutate(whiff = description == "swinging_strike",
         whiff = as.character(whiff))

all <- read_csv("CSVs/all_pitches.csv") %>% 
  mutate(distance_sweet = sqrt(((plate_x - 0.85)^2)+((plate_z - 1.55)^2)))
```

<br>
<br>

### **Linear Regression With/Without Interaction Terms**

<br>

``` {r LR Comparison RHP Sliders}

# Model Data (Pitch = Slider, Pitching Hand = Right)
model_data <- arsenal %>% 
  filter(pitch_type == "SL",
         pitch_hand == "R") %>% 
  mutate(ovr_break = sqrt(pitcher_break_x^2 + pitcher_break_z^2))

# Simple Linear Regression
lm_simple <- lm(xwOBA ~ 
                  pitch_speed + spin_rate + pitcher_break_x + pitcher_break_z +
                  pitch_usage + ovr_break,
                data = model_data)


# Overview of all model combinations
model_all <- ols_step_all_possible(lm_simple)

# Backwards Elimination
lm_simple %>% ols_step_backward_p(penter = 0.2)

# Stepwise Selection
lm_simple %>% ols_step_both_p(prem = 0.15, pent = 0.15)

# New Model
lm1 <- lm(xwOBA ~ 
            ovr_break + pitch_usage + pitch_speed,
          data = model_data)

# Interaction Linear Regression
lm_interact <- lm(xwOBA ~ 
                    pitch_speed + spin_rate + pitcher_break_x + pitcher_break_z + pitch_usage + 
                    ovr_break + 
                    pitch_speed*spin_rate + pitch_speed*pitch_usage + pitch_speed*ovr_break +
                    pitch_speed*pitcher_break_x + pitch_speed*pitcher_break_z + 
                    spin_rate*ovr_break + spin_rate*pitcher_break_x + spin_rate*pitcher_break_z +
                    pitch_usage*ovr_break + pitch_usage*spin_rate,
                  data = model_data)


# model_interact_all <- ols_step_all_possible(lm_interact)

# Stepwise Selection
lm_interact %>% ols_step_both_p(pent = 0.15, prem = 0.05)

# Output removes ALL interactions for p < 0.05
# Keeps same as simple LM pitcher_break_z + pitch_speed + pitch_usage

lm_interact %>% ols_step_both_p(pent = 0.15, prem = 0.10)

# New Model with Interactions (p -value < 0.10 threshhold)
lm2 <- lm(xwOBA ~ 
            pitch_speed + pitch_usage + 
            pitch_speed*ovr_break + pitch_speed*pitcher_break_z,
          data = model_data)


# Trimmed Data
model_results <- model_data %>% 
  select(first_name, last_name, 
         pitch_speed, pitch_usage, pitcher_break_z, ovr_break, xwOBA)

# Comparing Model Predictions
# lm1 = simple
# lm2 = interactions

model_results <- model_results %>% 
  mutate(lm1 = predict(lm1, model_results)) %>% 
  mutate(lm2 = predict(lm2, model_results))

# R and RMSE of Simple Linear Model
with(model_results, cor(xwOBA, lm1))
with(model_results, rmse(xwOBA, lm1))

# R and RMSE of Interactions Linear Model
with(model_results, cor(xwOBA, lm2))
with(model_results, rmse(xwOBA, lm2))

model_results %>% 
  select(xwOBA, lm1, lm2) %>%
  pivot_longer(cols = lm1:lm2, 
               names_to = "model",
               values_to = "pred") %>% 
  mutate(model = str_replace(model, "lm1", "Simple LM"),
         model = str_replace(model, "lm2", "Interaction LM")) %>%
  ggplot(aes(x = xwOBA, y = pred, color = model)) +
  geom_point(shape = 18, size = 1.5, alpha = 0.75) + 
  geom_smooth(se = FALSE) +
  scale_color_manual(values = c("navyblue", "skyblue")) +
  theme_classic() +
  labs(title = "Linear Models for RHP",
       x = "Observed",
       y = "Predicted",
       color = "Model")
```

``` {r LR Comparison LHP Sliders}
# Model Data (Pitch = Slider, Pitching Hand = Left)
model_data_l <- arsenal %>% 
  filter(pitch_type == "SL",
         pitch_hand == "L") %>% 
  mutate(ovr_break = sqrt(pitcher_break_x^2 + pitcher_break_z^2))

# Simple Linear Regression
lm_simple_l <- lm(xwOBA ~ 
                    pitch_speed + spin_rate + pitcher_break_x + pitcher_break_z +
                    pitch_usage + ovr_break,
                  data = model_data_l)



# Overview of all model combinations
model_all_l <- ols_step_all_possible(lm_simple_l)

# Backwards Elimination
lm_simple_l %>% ols_step_backward_p(penter = 0.15)

# Stepwise Selection
# lm_simple_l %>% ols_step_both_p(prem = 0.15, pent = 0.15)

# New Model
lm1_l <- lm(xwOBA ~ 
              pitcher_break_x + pitcher_break_z +
              ovr_break,
            data = model_data_l)


# Model Data (Pitch = Slider, Pitching Hand = Left)

# Interaction Linear Regression
lm_interact_l <- lm(xwOBA ~ 
                      pitch_speed + spin_rate + pitcher_break_x + pitcher_break_z + pitch_usage + 
                      ovr_break + 
                      pitch_speed*spin_rate + pitch_speed*pitch_usage + pitch_speed*ovr_break +
                      pitch_speed*pitcher_break_x + pitch_speed*pitcher_break_z + 
                      spin_rate*ovr_break + spin_rate*pitcher_break_x + spin_rate*pitcher_break_z +
                      pitch_usage*ovr_break + pitch_usage*spin_rate,
                    data = model_data_l)


# model_interact_all <- ols_step_all_possible(lm_interact)

# Stepwise Selection
# lm_interact_l %>% ols_step_both_p(pent = 0.15, prem = 0.05)

# Output removes ALL interactions for p < 0.05
# Keeps same as simple LM pitcher_break_z + pitch_speed + pitch_usage

# lm_interact_l %>% ols_step_both_p(pent = 0.20, prem = 0.05)

# New Model with Interactions (p -value < 0.10 threshhold)
lm2_l <- lm(xwOBA ~ 
              spin_rate*pitcher_break_z,
            data = model_data_l)


# Trimmed Data
model_results_l <- model_data_l %>% 
  select(first_name, last_name, 
         pitch_speed, pitch_usage, pitcher_break_z, ovr_break, xwOBA)

# Comparing Model Predictions
# lm1 = simple
# lm2 = interactions

model_results_l <- model_results_l %>% 
  mutate(lm1 = predict(lm1, model_results_l)) %>% 
  mutate(lm2 = predict(lm2, model_results_l))

# R and RMSE of Simple Linear Model
with(model_results_l, cor(xwOBA, lm1))
with(model_results_l, rmse(xwOBA, lm1))

# R and RMSE of Interactions Linear Model
with(model_results_l, cor(xwOBA, lm2))
with(model_results_l, rmse(xwOBA, lm2))

model_results_l %>% 
  select(xwOBA, lm1, lm2) %>%
  pivot_longer(cols = lm1:lm2, 
               names_to = "model",
               values_to = "pred") %>% 
  mutate(model = str_replace(model, "lm1", "Simple LM"),
         model = str_replace(model, "lm2", "Interaction LM")) %>%
  ggplot(aes(x = xwOBA, y = pred, color = model)) +
  geom_point(shape = 18, size = 1.5, alpha = 0.75) + 
  geom_smooth(se = FALSE) +
  scale_color_manual(values = c("navyblue", "skyblue")) +
  theme_classic() +
  labs(title = "Linear Models for LHP",
       x = "Observed",
       y = "Predicted",
       color = "Model")
```

``` {r LR Comparison Pitch-by-Pitch Data Sliders}
# Pitch by Pitch Data (Sliders)
pitches <- pitchers %>% 
  filter(pitch_type == "SL") %>% 
  mutate(pfx_x = pfx_x*12,
         pfx_z = pfx_z*12,
         ovr_break = round(sqrt(pfx_x^2 + pfx_z^2), 3))

# Simple Linear Regression
lm_pitches <- lm(delta_run_exp ~ 
                   release_speed + release_spin_rate + pfx_x + pfx_z +
                   ovr_break + release_extension,
                 data = pitches)



# Stepwise Selection
# lm_pitches %>% ols_step_both_p(prem = 0.25, pent = 0.15)

# New Model
lm1_pitches <- lm(delta_run_exp ~ 
                    release_spin_rate + pfx_x + release_extension,
                  data = pitches)


# Interaction Linear Regression
lm_interact_pitches <- lm(delta_run_exp ~ 
                            release_speed + release_spin_rate + pfx_x + pfx_z +
                            ovr_break + release_extension +
                            release_speed*release_spin_rate + release_speed*pfx_x +
                            release_speed*pfx_z + release_speed*ovr_break +
                            release_speed*release_extension + 
                            release_spin_rate*pfx_x + release_spin_rate*pfx_z + 
                            release_spin_rate*ovr_break + release_spin_rate*release_extension +
                            release_extension*pfx_x + release_extension*pfx_z + release_extension*ovr_break,
                          data = pitches)


# model_interact_all <- ols_step_all_possible(lm_interact)

# Stepwise Selection
lm_interact_pitches %>% ols_step_both_p(pent = 0.15, prem = 0.15)

lm2_pitches <- lm(delta_run_exp ~ 
                    release_spin_rate*pfx_x + release_extension,
                  data = pitches)


model_results_pitches <- pitches %>% 
  select(delta_run_exp, release_speed, release_spin_rate, pfx_x, pfx_z,
         release_extension) %>% 
  mutate(lm1 = predict(lm1_pitches, pitches),
         lm2 = predict(lm2_pitches, pitches))

# R and RMSE of Simple Linear Model

model_results_pitches %>% 
  filter(!is.na(release_spin_rate),
         !is.na(pfx_x),
         !is.na(release_extension),
         !is.na(delta_run_exp)) %>% 
  with(cor(delta_run_exp, lm1))

model_results_pitches %>% 
  filter(!is.na(release_spin_rate),
         !is.na(pfx_x),
         !is.na(release_extension),
         !is.na(delta_run_exp)) %>% 
  with(rmse(delta_run_exp, lm1))

# R and RMSE of Interaction Linear Model
model_results_pitches %>% 
  filter(!is.na(release_spin_rate),
         !is.na(pfx_x),
         !is.na(release_extension),
         !is.na(delta_run_exp)) %>% 
  with(cor(delta_run_exp, lm2))

model_results_pitches %>% 
  filter(!is.na(release_spin_rate),
         !is.na(pfx_x),
         !is.na(release_extension),
         !is.na(delta_run_exp)) %>% 
  with(rmse(delta_run_exp, lm2))

# Graph
model_results_pitches %>% 
  select(delta_run_exp, lm1, lm2) %>%
  pivot_longer(cols = lm1:lm2, 
               names_to = "model",
               values_to = "pred") %>% 
  mutate(model = str_replace(model, "lm1", "Simple LM"),
         model = str_replace(model, "lm2", "Interaction LM")) %>%
  ggplot(aes(x = delta_run_exp, y = pred, color = model)) +
  geom_point(shape = 18, size = 1.5, alpha = 0.75) + 
  geom_smooth(se = FALSE) +
  scale_color_manual(values = c("navyblue", "skyblue")) +
  theme_classic() +
  labs(title = "Linear Models for Pitch-by-Pitch Data",
       subtitle = "Predicting Run Expectancy Added",
       caption = "Pitchers: Scherzer, Taillon, Keller, Manoah, Gallen, Garcia, Gray",
       x = "Observed",
       y = "Predicted",
       color = "Model")

```

```{r LR Comparison w/ ID Pitch-by-Pitch Data Sliders}
model_results_pitches_2 <- pitches %>% 
  select(delta_run_exp, release_speed, release_spin_rate, pfx_x, pfx_z,
         release_extension, ID) %>% 
  mutate(lm1 = predict(lm1_pitches, pitches),
         lm2 = predict(lm2_pitches, pitches))

# Graph
model_results_pitches_2 %>% 
  select(ID,delta_run_exp, lm1, lm2) %>%
  pivot_longer(cols = lm1:lm2, 
               names_to = "model",
               values_to = "pred") %>% 
  mutate(model = str_replace(model, "lm1", "Simple LM"),
         model = str_replace(model, "lm2", "Interaction LM")) %>%
  ggplot(aes(x = delta_run_exp, y = pred, color = model)) +
  geom_point(shape = 18, size = 1.5, alpha = 0.75) + 
  geom_smooth(se = FALSE) +
  scale_color_manual(values = c("navyblue", "skyblue")) +
  facet_wrap(~ ID, ncol = 1) +
  theme_classic() +
  labs(title = "Linear Models for Pitch-by-Pitch Data",
       subtitle = "Predicting Run Expectancy Added",
       caption = "Pitchers: Scherzer, Taillon, Keller, Manoah, Gallen, Garcia, Gray",
       x = "Observed",
       y = "Predicted",
       color = "Model")

# Correlations

model_results_pitches_2 %>% 
  filter(ID == "Great") %>% 
  filter(!is.na(release_spin_rate),
         !is.na(pfx_x),
         !is.na(release_extension),
         !is.na(delta_run_exp)) %>% 
  with(cor(delta_run_exp, lm1))

model_results_pitches_2 %>% 
  filter(ID == "Decent") %>% 
  filter(!is.na(release_spin_rate),
         !is.na(pfx_x),
         !is.na(release_extension),
         !is.na(delta_run_exp)) %>% 
  with(cor(delta_run_exp, lm1))

model_results_pitches_2 %>% 
  filter(ID == "Bad") %>% 
  filter(!is.na(release_spin_rate),
         !is.na(pfx_x),
         !is.na(release_extension),
         !is.na(delta_run_exp)) %>% 
  with(cor(delta_run_exp, lm1))


# RMSE

model_results_pitches_2 %>% 
  filter(ID == "Great") %>% 
  filter(!is.na(release_spin_rate),
         !is.na(pfx_x),
         !is.na(release_extension),
         !is.na(delta_run_exp)) %>% 
  with(rmse(delta_run_exp, lm1))

model_results_pitches_2 %>% 
  filter(ID == "Decent") %>% 
  filter(!is.na(release_spin_rate),
         !is.na(pfx_x),
         !is.na(release_extension),
         !is.na(delta_run_exp)) %>% 
  with(rmse(delta_run_exp, lm1))

model_results_pitches_2 %>% 
  filter(ID == "Bad") %>% 
  filter(!is.na(release_spin_rate),
         !is.na(pfx_x),
         !is.na(release_extension),
         !is.na(delta_run_exp)) %>% 
  with(rmse(delta_run_exp, lm1))
```

```{r}
pitchers %>% 
  # filter(pitch_type == "SL") %>%
  ggplot(aes(x = plate_z)) +
  geom_histogram(binwidth = 0.15, color = "white")

pitchers %>% 
  ggplot(aes(x = delta_run_exp)) +
  geom_histogram(binwidth = 0.15, color = "white")

pitchers %>% 
  filter(pitch_type %in% c("FF", "SL", "CH")) %>%
  mutate(pitch_dist = sqrt(plate_x^2 + (2.5 - plate_z)^2)) %>% 
  ggplot(aes(x = pitch_dist, color = ID)) +
  geom_density() +
  facet_wrap(~ pitch_type,
             ncol = 1)

pitchers %>% 
  filter(pitch_type %in% c("FF", "SL", "CH")) %>%
  mutate(pitch_dist = sqrt(plate_x^2 + (2.5 - plate_z)^2)) %>%
  ggplot(aes(x = pitch_dist, y = delta_run_exp)) +
  geom_point(alpha = 0.15)
```

<br>
<br>

### **Modeling with Difference Variables**

<br>

```{r Model, warning = FALSE, message = FALSE}
# Model?
model <- lm(delta_run_exp ~ dist + speed_change + break_change, 
            data = pitchers)

preds <- pitchers %>% 
  mutate(predicted = predict(model, pitchers)) %>% 
  rename(observed = delta_run_exp) %>% 
  select(ID, zone, pitch_type, observed, predicted) %>% 
  filter(pitch_type != "PO")

acc <- preds %>% 
  ggplot(aes(x = observed, y = predicted)) +
  geom_point(alpha = 0.5) +
  geom_smooth()

acc

acc +
  facet_wrap(~ pitch_type)

acc +
  facet_wrap(~ ID)
```

```{r CV FF Model, warning = FALSE, message = FALSE}
data_ff <- pitchers %>% 
  filter(pitch_type == "FF",
         !is.na(break_change)) %>%  
  filter(pitch_type != "PO")

model_ff <- train(
  delta_run_exp ~ dist + speed_change + break_change + release_speed + pfx_x + pfx_z,
  data = data_ff,
  method = "ranger",
  trControl = trainControl(method = "cv", number = 5))

preds_ff <- cbind(data_ff, predict(model_ff)) %>% 
  as.data.frame() %>% 
  rename(observed = delta_run_exp,
         predicted = "predict(model_ff)") %>% 
  select(ID, zone, pitch_type, observed, predicted)

preds_ff %>% 
  ggplot(aes(x = observed, y = predicted)) +
  geom_point() +
  geom_smooth() +
  geom_abline(slope = 1, intercept = 0) +
  coord_fixed() +
  labs(title = "Fastball RF Model",
       caption = paste0("RMSE: ", round(rmse(preds_ff$observed, preds_ff$predicted), 4)))

preds_ff %>% 
  filter(!is.na(observed),
         !is.na(predicted)) %>% 
  with(cor(observed, predicted))



```

```{r FF Model, warning = FALSE, message = FALSE}
data_ff <- pitchers %>% 
  filter(pitch_type == "FF",
         !is.na(break_change))

model_ff <- ranger(delta_run_exp ~ dist + speed_change + break_change, 
            data = data_ff, mtry = 2)

preds_ff <- data_ff %>% 
  mutate(predicted = predict(model_ff, data_ff)$predictions) %>% 
  rename(observed = delta_run_exp) %>% 
  select(ID, zone, pitch_type, observed, predicted) %>% 
  filter(pitch_type != "PO")

preds_ff %>% 
  ggplot(aes(x = observed, y = predicted)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Fastball RF Model",
       caption = paste0("RMSE: ", round(rmse(preds_ff$observed, preds_ff$predicted), 4)))

preds_ff %>% 
  filter(!is.na(observed),
         !is.na(predicted)) %>% 
  with(cor(observed, predicted))
```


```{r SI Model, warning = FALSE, message = FALSE}
data_si <- pitchers %>% 
  filter(pitch_type == "SI",
         !is.na(break_change))

model_si <- ranger(delta_run_exp ~ dist + speed_change + break_change, 
            data = data_si, mtry = 2)

preds_si <- data_si %>% 
  mutate(predicted = predict(model_si, data_si)$predictions) %>% 
  rename(observed = delta_run_exp) %>% 
  select(ID, zone, pitch_type, observed, predicted) %>% 
  filter(pitch_type != "PO")

preds_si %>% 
  ggplot(aes(x = observed, y = predicted)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Sinker RF Model",
       caption = paste0("RMSE: ", round(rmse(preds_si$observed, preds_si$predicted), 4)))

preds_si %>% 
  filter(!is.na(observed),
         !is.na(predicted)) %>% 
  with(cor(observed, predicted))
```


```{r CH Model, warning = FALSE, message = FALSE}
data_ch <- pitchers %>% 
  filter(pitch_type == "CH",
         !is.na(break_change))

model_ch <- ranger(delta_run_exp ~ dist + speed_change + break_change, 
            data = data_ch, mtry = 2)

preds_ch <- data_ch %>% 
  mutate(predicted = predict(model_ch, data_ch)$predictions) %>% 
  rename(observed = delta_run_exp) %>% 
  select(ID, zone, pitch_type, observed, predicted) %>% 
  filter(pitch_type != "PO")

preds_ch %>% 
  ggplot(aes(x = observed, y = predicted)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Change-Up RF Model",
       caption = paste0("RMSE: ", round(rmse(preds_ch$observed, preds_ch$predicted), 4)))

preds_ch %>% 
  filter(!is.na(observed),
         !is.na(predicted)) %>% 
  with(cor(observed, predicted))
```


```{r SL Model, warning = FALSE, message = FALSE}
data_sl <- pitchers %>% 
  filter(pitch_type == "SL",
         !is.na(break_change))

model_sl <- ranger(delta_run_exp ~ dist + speed_change + break_change, 
            data = data_sl, mtry = 2)

preds_sl <- data_sl %>% 
  mutate(predicted = predict(model_sl, data_sl)$predictions) %>% 
  rename(observed = delta_run_exp) %>% 
  select(ID, zone, pitch_type, observed, predicted) %>% 
  filter(pitch_type != "PO")

preds_sl %>% 
  ggplot(aes(x = observed, y = predicted)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Slider RF Model",
       caption = paste0("RMSE: ", round(rmse(preds_sl$observed, preds_sl$predicted), 4)))

preds_sl %>% 
  filter(!is.na(observed),
         !is.na(predicted)) %>% 
  with(cor(observed, predicted))

# 
# Actmodel <- train(delta_run_exp ~ dist + speed_change + break_change,
#                   data = data_sl, method = "ranger", 
#                   trControl = trainControl(method = "cv", number = 10, verboseIter = TRUE), preProcess = c("knnImpute"))
# plot(Actmodel$finalModel$forest)
```

<br>

### **Logistic Regression Whiff RHP**

``` {r Basic Logistic RHP, warning = FALSE, message = FALSE}

# Slider Logistic Model
whiff_sl <- whiff %>% 
  filter(pitch_type == "SL") %>% 
  mutate(whiff = str_replace(whiff, "TRUE", "1"),
         whiff = str_replace(whiff, "FALSE", "0"),
         whiff = as.numeric(whiff))

# Original Model
model1 <- glm(whiff ~ release_speed + spin_axis + pfx_x + pfx_z + plate_x + plate_z +
              release_spin_rate + speed_change + break_change + pfx_total + dist,
              data = whiff_sl, family = binomial)

# Reduced Model
model1 <- glm(whiff ~ release_speed + plate_x + plate_z +
              release_spin_rate + speed_change + break_change + pfx_total + dist,
              data = whiff_sl, family = binomial)

summary(model1)

preds <- whiff_sl %>% 
  mutate(prediction_log = predict(model1, whiff_sl),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

preds %>% 
  ggplot(aes(x = as.character(whiff), y = prediction)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.1, width = 0.1, height = 0)

preds %>% 
  mutate(prediction = round(prediction, 2)) %>% 
  group_by(prediction) %>% 
  summarize(mean(whiff)) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = prediction, y = `mean(whiff)`)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  labs(y = "observed whiff proportion",
       x = "projected % whiff chance",
       title = "Whiff proportion by predicted whiff value",
       subtitle = "Whiff predictions have a 1% bin width")
```

```{r}
preds %>% 
  arrange(desc(prediction)) %>% 
  head(10)

whiff %>% 
  mutate(count = paste0(balls, "-", strikes)) %>% 
  filter(pitch_type == "SL") %>% 
  ggplot(aes(y = whiff, x = pfx_z*12)) +
  geom_violin() +
  geom_boxplot(alpha = 0.5, width = 0.5) +
  facet_wrap(~count) +
  labs(title = "Whiff vs. Non-Whiff by Vertical Movement",
       x = "Induced Vertical Movement (in.)",
       y = "Outcome") +
  NULL
```

```{r}
# Sliders
whiff %>% 
  filter(pitch_type =="SL") %>% 
  ggplot(aes(x = -plate_x, y = plate_z)) + 
  geom_density_2d_filled(contour_var = "density", alpha = 0.5) +
  geom_zone() +
  # geom_point(alpha = 0.2) +
  coord_fixed() +
  facet_grid(cols = vars(stand), rows = vars(whiff)) +
  theme_bw()

# Fastballs
whiff %>% 
  filter(pitch_type =="FF") %>% 
  ggplot(aes(x = -plate_x, y = plate_z)) + 
  geom_density_2d_filled(contour_var = "density", alpha = 0.5) +
  geom_zone() +
  # geom_point(alpha = 0.2) +
  coord_fixed() +
  facet_grid(cols = vars(stand), rows = vars(whiff)) +
  theme_bw()


# Change-Ups
whiff %>% 
  filter(pitch_type =="CH") %>% 
  ggplot(aes(x = -plate_x, y = plate_z)) + 
  geom_density_2d_filled(contour_var = "density", alpha = 0.5) +
  geom_zone() +
  # geom_point(alpha = 0.2) +
  coord_fixed() +
  facet_grid(cols = vars(stand), rows = vars(whiff)) +
  theme_bw()
```

```{r}
whiff %>% 
  arrange(game_date, player_name, at_bat_number, pitch_number) %>% 
  mutate(prev_pitch = lag(pitch_type, n = 1, default = NA)) %>% 
  filter(stand == "R",
         pitch_type == "SL",
         prev_pitch  %in% c("FF", "CH", "SL", "CU"),
         player_name == "Scherzer, Max") %>% 
  ggplot(aes(x = -plate_x, y = plate_z)) + 
  geom_density_2d_filled(contour_var = "density", alpha = 0.5) +
  geom_zone() +
  coord_fixed() +
  facet_grid(cols = vars(prev_pitch), rows = vars(whiff)) +
  theme_bw()


whiff %>% 
  arrange(game_date, player_name, at_bat_number, pitch_number) %>% 
  mutate(prev_pitch = lag(pitch_type, n = 1, default = NA)) %>% 
  filter(stand == "R",
         pitch_type == "FF") %>% 
  ggplot(aes(x = -plate_x, y = plate_z)) + 
  geom_density_2d_filled(contour_var = "density", alpha = 0.5) +
  geom_zone() +
  coord_fixed() +
  facet_grid(cols = vars(player_name), rows = vars(whiff)) +
  theme_bw()

zoned <- whiff %>% 
  mutate(loc_x = round(plate_x*3, 0),
         loc_y = round(plate_z*3, 0))

zoned %>% 
  filter(pitch_type == "FF",
         plate_z > 0 & plate_z < 6,
         plate_x > -1.5 & plate_x < 1.5) %>% 
  summarize(whiff_perc = mean(whiff == "TRUE"),
            pitches = n(),
            .by = c(loc_x, loc_y, player_name)) %>% 
  filter(pitches >= 10) %>% 
  ggplot(aes(x = -loc_x, y = loc_y, fill = whiff_perc)) + 
  geom_tile() +
  scale_fill_gradient(low = "gray", high = "red") +
  facet_wrap(~ player_name) +
  coord_fixed() +
  theme_bw()
```


<br>

### **Logistic Regression Whiff LHP**

#### Logistic Regression
``` {r Basic Logistic LHP, warning = FALSE, message = FALSE}

# Slider Logistic Model
whiff_sl2 <- whiff_l %>% 
  filter(pitch_type == "SL") %>% 
  mutate(whiff = str_replace(whiff, "TRUE", "1"),
         whiff = str_replace(whiff, "FALSE", "0"),
         whiff = as.numeric(whiff))

# Original Model
model2 <- glm(whiff ~ pitch_speed + spin_axis + pfx_x + pfx_z + plate_x + plate_z +
              release_spin_rate + speed_change + break_change + pfx_total + distance,
              data = whiff_sl2, family = binomial)

# Reduced Model
model2 <- glm(whiff ~ pitch_speed + plate_x + plate_z +
              release_spin_rate + speed_change + break_change + pfx_total + distance,
              data = whiff_sl2, family = binomial)

summary(model2)

preds2 <- whiff_sl2 %>% 
  mutate(prediction_log = predict(model2, whiff_sl2),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

preds2 %>% 
  ggplot(aes(x = as.character(whiff), y = prediction)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.1, width = 0.1, height = 0)

preds2 %>% 
  mutate(prediction = round(prediction, 2)) %>% 
  group_by(prediction) %>% 
  summarize(mean(whiff)) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = prediction, y = `mean(whiff)`)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  labs(y = "observed whiff proportion",
       x = "projected % whiff chance",
       title = "Whiff proportion by predicted whiff value",
       subtitle = "Whiff predictions have a 1% bin width")
```

```{r, warning = FALSE, message = FALSE}
whiff_l %>% 
  mutate(count = paste0(balls, "-", strikes)) %>% 
  filter(pitch_type == "SL") %>% 
  ggplot(aes(y = whiff, x = pfx_z*12)) +
  geom_violin() +
  geom_boxplot(alpha = 0.5, width = 0.5) +
  facet_wrap(~count) +
  labs(title = "Whiff vs. Non-Whiff by Vertical Movement",
       x = "Induced Vertical Movement (in.)",
       y = "Outcome") +
  NULL
```

```{r, warning = FALSE, message = FALSE}
# Sliders
whiff_l %>% 
  filter(pitch_type =="SL") %>% 
  ggplot(aes(x = -plate_x, y = plate_z)) + 
  geom_density_2d_filled(contour_var = "density", alpha = 0.5) +
  geom_zone() +
  # geom_point(alpha = 0.2) +
  coord_fixed() +
  facet_grid(cols = vars(hitter), rows = vars(whiff)) +
  theme_bw()

# Fastballs
whiff_l %>% 
  filter(pitch_type =="FF") %>% 
  ggplot(aes(x = -plate_x, y = plate_z)) + 
  geom_density_2d_filled(contour_var = "density", alpha = 0.5) +
  geom_zone() +
  # geom_point(alpha = 0.2) +
  coord_fixed() +
  facet_grid(cols = vars(hitter), rows = vars(whiff)) +
  theme_bw()


# Change-Ups
whiff_l %>% 
  filter(pitch_type =="CH") %>% 
  ggplot(aes(x = -plate_x, y = plate_z)) + 
  geom_density_2d_filled(contour_var = "density", alpha = 0.5) +
  geom_zone() +
  # geom_point(alpha = 0.2) +
  coord_fixed() +
  facet_grid(cols = vars(hitter), rows = vars(whiff)) +
  theme_bw()
```

```{r, warning = FALSE, message = FALSE}
whiff_l %>% 
  arrange(game_date, player_name, at_bat_number, pitch_number) %>% 
  mutate(prev_pitch = lag(pitch_type, n = 1, default = NA)) %>% 
  filter(hitter == "R",
         pitch_type == "SL",
         prev_pitch  %in% c("FF", "CH", "SL", "CU"),
         player_name == "Fried, Max") %>% 
  ggplot(aes(x = -plate_x, y = plate_z)) + 
  geom_density_2d_filled(contour_var = "density", alpha = 0.5) +
  geom_zone() +
  coord_fixed() +
  facet_grid(cols = vars(prev_pitch), rows = vars(whiff)) +
  theme_bw()


whiff_l %>% 
  arrange(game_date, player_name, at_bat_number, pitch_number) %>% 
  mutate(prev_pitch = lag(pitch_type, n = 1, default = NA)) %>% 
  filter(hitter == "R",
         pitch_type == "FF") %>% 
  ggplot(aes(x = -plate_x, y = plate_z)) + 
  geom_density_2d_filled(contour_var = "density", alpha = 0.5) +
  geom_zone() +
  coord_fixed() +
  facet_grid(cols = vars(player_name), rows = vars(whiff)) +
  theme_bw()

zoned2 <- whiff_l %>% 
  mutate(loc_x = round(plate_x*3, 0),
         loc_y = round(plate_z*3, 0))

zoned2 %>% 
  filter(pitch_type == "FF",
         plate_z > 0 & plate_z < 6,
         plate_x > -1.5 & plate_x < 1.5) %>% 
  summarize(whiff_perc = mean(whiff == "TRUE"),
            pitches = n(),
            .by = c(loc_x, loc_y, player_name)) %>% 
  filter(pitches >= 10) %>% 
  ggplot(aes(x = -loc_x, y = loc_y, fill = whiff_perc)) + 
  geom_tile() +
  scale_fill_gradient(low = "gray", high = "red") +
  facet_wrap(~ player_name) +
  coord_fixed() +
  theme_bw()
```

<br>

### ***Logistic Regression Whiff Model Test (RHP Sliders / Fastballs)***

```{r, message = FALSE, warning = FALSE}

all2 <- all %>% 
  filter(!is.na(pfx_z)) %>% 
  mutate(distance_sweet = sqrt(((plate_x - 0.85)^2)+((plate_z - 1.55)^2))) %>% 
  mutate(zone = case_when(distance < 2 ~ zone,
                          distance >= 2 & plate_z > (sz_top + sz_bot)/2 ~ 16,
                          distance >= 2 & plate_z <= (sz_top + sz_bot)/2 ~ 17)) %>% 
  mutate(ab_id = paste0(game_date, "_", player_id, "_", at_bat_number),
         prev_ab_id = lead(ab_id, 1)) %>% 
  mutate(prev_pitch = ifelse(ab_id == prev_ab_id, lead(pitch_type, 1), NA)) %>% 
  select(-ab_id, -prev_ab_id)

all_ff <- all2 %>%
  filter(pitch_type == "FF") %>% 
  summarize(fb_z = mean(pfx_z),
            fb_x = mean(pfx_x),
            fb_mph = mean(pitch_speed),
            .by = c(game_date, player_id))


all2 <- all2 %>% 
  left_join(all_ff, by = c("game_date" = "game_date",
                                 "player_id" = "player_id")) %>% 
  mutate(pfx_x_diff = (fb_x - pfx_x),
         pfx_z_diff = (fb_z = pfx_z),
         speed_ff_diff = (fb_mph - pitch_speed))

sliders <- all2 %>% 
  filter(p_throws == "R",
         hitter == "R") %>% 
  filter(pitch_type == "SL") %>% 
  mutate(count = paste0(balls, "_", strikes),
         prev_pitch = as.factor(prev_pitch)) %>% 
  mutate(prev_pitch_ff = ifelse(prev_pitch == "FF", 1, 0))
  
fastballs <- all2 %>% 
  filter(p_throws == "R",
         hitter == "R") %>% 
  filter(pitch_type == "FF") %>% 
  mutate(count = paste0(balls, "_", strikes),
         prev_pitch = as.factor(prev_pitch))

```

```{r Slider Model, message = FALSE}
# Initial Model
sl_model_all <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              balls + strikes + pfx_total + speed_change + break_change + distance + 
                prev_pitch_ff + pfx_x_diff + pfx_z_diff + speed_ff_diff,
              data = sliders, family = binomial)

# Model Evaluation
# summary(sl_model_all)

sl_model <- glm(whiff ~ pfx_x + pfx_z + plate_x + plate_z + zone +
              balls + pfx_total + speed_change + break_change + distance + 
                prev_pitch_ff + pfx_x_diff + speed_ff_diff,
              data = sliders, family = binomial)

# Model Predictions
sl_preds <- sliders %>% 
  mutate(prediction_log = predict(sl_model, sliders),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

sl_preds %>% 
  mutate(prediction = round(prediction, 2)) %>% 
  group_by(prediction) %>% 
  summarize(n = n(), whiff_rate = mean(whiff)) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = prediction, y = whiff_rate)) +
  geom_point(aes(size = n)) + # size of bin shown on graph
  coord_fixed() +
  geom_smooth(se = FALSE) +
  labs(y = "observed whiff proportion",
       x = "projected % whiff chance",
       title = "Slider Whiff Model Prediction",
       subtitle = "Whiff proportion by predicted whiff value",
       caption = "Whiff predictions have a 1% bin width")
```


```{r Slider Model by Count, include = FALSE, }
## 0 Strikes
# Initial Model
sl_model0_all <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              balls + pfx_total + speed_change + break_change + distance + 
                prev_pitch_ff + pfx_x_diff + speed_ff_diff,
              data = filter(sliders, strikes == 0), family = binomial)

# Model Evaluation
summary(sl_model0_all)

sl_model0 <- glm(whiff ~ pitch_speed + pfx_z + plate_x + plate_z + zone +
              balls + pfx_total + distance + 
                pfx_x_diff + pfx_z_diff,
              data = filter(sliders, strikes == 0), family = binomial)

# Model Predictions
sl_preds0 <- sliders %>% 
  filter(strikes == 0) %>% 
  mutate(prediction_log = predict(sl_model0, filter(sliders, strikes == 0)),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

sl0 <- sl_preds0 %>% 
  mutate(prediction = round(prediction, 2)) %>% 
  group_by(prediction) %>% 
  summarize(mean(whiff)) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = prediction, y = `mean(whiff)`)) +
  geom_point() +
  coord_fixed() +
  geom_smooth(se = FALSE) +
  labs(y = "observed whiff proportion",
       x = "projected % whiff chance",
       title = "0 Strike Slider Whiff Model Prediction",
       caption = "Variables: pitch_speed, pfx_z, plate_x, 
       plate_z, zone, balls,
       pfx_total, distance, 
       pfx_x_diff, pfx_z_diff")


## 1 Strike
# Initial Model
sl_model1_all <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              balls + pfx_total + speed_change + break_change + distance + 
                prev_pitch_ff + pfx_x_diff + pfx_z_diff + speed_ff_diff,
              data = filter(sliders, strikes == 1), family = binomial)

# Model Evaluation
summary(sl_model1_all)

sl_model1 <- glm(whiff ~ plate_x + plate_z + zone +
              pfx_total + break_change + distance + 
                prev_pitch_ff + speed_ff_diff,
              data = filter(sliders, strikes == 1), family = binomial)

# Model Predictions
sl_preds1 <- sliders %>% 
  filter(strikes == 1) %>% 
  mutate(prediction_log = predict(sl_model1, filter(sliders, strikes == 1)),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

sl1 <- sl_preds1 %>% 
  mutate(prediction = round(prediction, 2)) %>% 
  group_by(prediction) %>% 
  summarize(mean(whiff)) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = prediction, y = `mean(whiff)`)) +
  geom_point() +
  coord_fixed() +
  geom_smooth(se = FALSE) +
  labs(y = "observed whiff proportion",
       x = "projected % whiff chance",
       title = "1 Strike Slider Whiff Model Prediction",
       caption = "Variables: plate_x, plate_z, 
       zone, pfx_total, 
       break_change, distance,
       prev_pitch_ff, speed_ff_diff")



## 2 Strike
# Initial Model
sl_model2_all <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              balls + pfx_total + speed_change + break_change + distance + 
                prev_pitch_ff + pfx_x_diff + pfx_z_diff + speed_ff_diff,
              data = filter(sliders, strikes == 2), family = binomial)

# Model Evaluation
summary(sl_model2_all)

sl_model2 <- glm(whiff ~ pfx_z + plate_x + plate_z + zone +
              balls + speed_change + distance + 
                prev_pitch_ff + speed_ff_diff,
              data = filter(sliders, strikes == 2), family = binomial)

# Model Predictions
sl_preds2 <- sliders %>% 
  filter(strikes == 2) %>% 
  mutate(prediction_log = predict(sl_model2, filter(sliders, strikes == 2)),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

sl2 <- sl_preds2 %>% 
  mutate(prediction = round(prediction, 2)) %>% 
  group_by(prediction) %>% 
  summarize(mean(whiff)) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = prediction, y = `mean(whiff)`)) +
  geom_point() +
  coord_fixed() +
  geom_smooth(se = FALSE) +
  labs(y = "observed whiff proportion",
       x = "projected % whiff chance",
       title = "2 Strike Slider Whiff Model Prediction",
       caption = "Variables: plate_x, plate_z,
       zone, balls, speed_change,
       distance, prev_pitch_ff,
       speed_ff_diff")

```

```{r Slider Model Predictions by Strike}
sl0 + sl1 + sl2
```



```{r 4-Seam Fastball Model, message = FALSE}
# Initial Model
ff_model_all <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              balls + pfx_total + speed_change + break_change + distance + 
                pfx_x_diff + pfx_z_diff + speed_ff_diff,
              data = fastballs, family = binomial)

# Model Evaluation
# summary(ff_model_all)

ff_model <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_z + zone +
              pfx_total + speed_change + break_change + distance + 
                pfx_x_diff,
              data = fastballs, family = binomial)

summary(ff_model)

# Model Predictions
ff_preds <- fastballs %>% 
  mutate(prediction_log = predict(ff_model, fastballs),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

ff_preds %>% 
  mutate(prediction = round(prediction, 2)) %>% 
  group_by(prediction) %>% 
  summarize(mean(whiff)) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = prediction, y = `mean(whiff)`)) +
  geom_point() +
  coord_fixed() +
  geom_smooth(se = FALSE) +
  labs(y = "observed whiff proportion",
       x = "projected % whiff chance",
       title = "Fastball Whiff Model Prediction",
       subtitle = "Whiff proportion by predicted whiff value",
       caption = "Whiff predictions have a 1% bin width")
```

```{r Fastballs Model by Count, include = FALSE, }
## 0 Strikes
# Initial Model
ff_model0_all <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              balls + pfx_total + speed_change + break_change + distance,
              data = filter(fastballs, strikes == 0), family = binomial)

# Model Evaluation
summary(ff_model0_all)

ff_model0 <- glm(whiff ~ pitch_speed + pfx_z + plate_z + zone +
              pfx_total + speed_change + break_change + distance,
              data = filter(fastballs, strikes == 0), family = binomial)

# Model Predictions
ff_preds0 <- fastballs %>% 
  filter(strikes == 0) %>% 
  mutate(prediction_log = predict(ff_model0, filter(fastballs, strikes == 0)),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

ff0 <- ff_preds0 %>% 
  mutate(prediction = round(prediction, 2)) %>% 
  group_by(prediction) %>% 
  summarize(mean(whiff)) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = prediction, y = `mean(whiff)`)) +
  geom_point() +
  coord_fixed() +
  geom_smooth(se = FALSE) +
  labs(y = "observed whiff proportion",
       x = "projected % whiff chance",
       title = "0 Strike Fastball Whiff Model Prediction",
       caption = "Variables: pitch_speed, pfx_z, plate_z, 
       zone, pfx_total, speed_change,
       break_change, distance")


## 1 Strike
# Initial Model
ff_model1_all <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              balls + pfx_total + speed_change + break_change + distance,
              data = filter(fastballs, strikes == 1), family = binomial)

# Model Evaluation
summary(ff_model1_all)

ff_model1 <- glm(whiff ~ pitch_speed + pfx_z + plate_z + zone +
              pfx_total + speed_change + break_change + distance,
              data = filter(fastballs, strikes == 1), family = binomial)

# Model Predictions
ff_preds1 <- fastballs %>% 
  filter(strikes == 1) %>% 
  mutate(prediction_log = predict(ff_model1, filter(fastballs, strikes == 1)),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

ff1 <- ff_preds1 %>% 
  mutate(prediction = round(prediction, 2)) %>% 
  group_by(prediction) %>% 
  summarize(mean(whiff)) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = prediction, y = `mean(whiff)`)) +
  geom_point() +
  coord_fixed() +
  geom_smooth(se = FALSE) +
  labs(y = "observed whiff proportion",
       x = "projected % whiff chance",
       title = "1 Strike Fastball Whiff Model Prediction",
       caption = "Variables: pitch_speed, pfx_z, plate_z, 
       zone, pfx_total, speed_change,
       break_change, distance")


## 2 Strikes
# Initial Model
ff_model2_all <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              balls + pfx_total + speed_change + break_change + distance,
              data = filter(fastballs, strikes == 2), family = binomial)

# Model Evaluation
summary(ff_model2_all)

ff_model2 <- glm(whiff ~ pitch_speed + pfx_z + plate_x + plate_z + zone +
              pfx_total + break_change + distance,
              data = filter(fastballs, strikes == 2), family = binomial)

# Model Predictions
ff_preds2 <- fastballs %>% 
  filter(strikes == 2) %>% 
  mutate(prediction_log = predict(ff_model2, filter(fastballs, strikes == 2)),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

ff2 <- ff_preds2 %>% 
  mutate(prediction = round(prediction, 2)) %>% 
  group_by(prediction) %>% 
  summarize(mean(whiff)) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = prediction, y = `mean(whiff)`)) +
  geom_point() +
  coord_fixed() +
  geom_smooth(se = FALSE) +
  labs(y = "observed whiff proportion",
       x = "projected % whiff chance",
       title = "2 Strikes Fastball Whiff Model Prediction",
       caption = "Variables: pitch_speed, pfx_z, 
       plate_x, plate_z, zone, 
       pfx_total, break_change, 
       distance")
```

```{r Fastball Model Predictions by Strike}
ff0 + ff1 + ff2
```

```{r Models with Sweet Spot}
## Sliders
# Model
sl_model_s <- glm(whiff ~ pfx_x + pfx_z + plate_x + plate_z + zone +
              balls + pfx_total + speed_change + break_change + distance + distance_sweet,
              data = sliders, family = binomial)

summary(sl_model_s)

# Model Predictions
sl_preds_s <- sliders %>% 
  mutate(prediction_log = predict(sl_model_s, sliders),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

sl_preds_s %>% 
  mutate(prediction = round(prediction, 2)) %>% 
  group_by(prediction) %>% 
  summarize(mean(whiff)) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = prediction, y = `mean(whiff)`)) +
  geom_point() +
  coord_fixed() +
  geom_smooth(se = FALSE) +
  labs(y = "observed whiff proportion",
       x = "projected % whiff chance",
       title = "Slider Whiff Model Prediction (w/ Sweet)")




## Fastball
# Model
ff_model_s <- glm(whiff ~ pitch_speed + pfx_z + plate_x + plate_z + zone +
              strikes + pfx_total + speed_change + break_change + distance,
              data = fastballs, family = binomial)

summary(ff_model_s)

# Model Predictions
ff_preds_s <- fastballs %>% 
  mutate(prediction_log = predict(ff_model_s, fastballs),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

ff_preds_s %>% 
  mutate(prediction = round(prediction, 2)) %>% 
  group_by(prediction) %>% 
  summarize(mean(whiff)) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = prediction, y = `mean(whiff)`)) +
  geom_point() +
  coord_fixed() +
  geom_smooth(se = FALSE) +
  labs(y = "observed whiff proportion",
       x = "projected % whiff chance",
       title = "Fastball Whiff Model Prediction (w/ Sweet)")
```

<br>

### ***Simplifying Previous Pitch Variable***

```{r, message = FALSE, warning = FALSE}

rhp <- RHP %>% 
  filter(!is.na(pfx_z)) %>% 
  mutate(distance_sweet = sqrt(((plate_x - 0.85)^2)+((plate_z - 1.55)^2))) %>% 
  mutate(zone = case_when(distance < 2 ~ zone,
                          distance >= 2 & plate_z > (sz_top + sz_bot)/2 ~ 16,
                          distance >= 2 & plate_z <= (sz_top + sz_bot)/2 ~ 17)) %>% 
  mutate(ab_id = paste0(game_date, "_", player_id, "_", at_bat_number),
         prev_ab_id = lead(ab_id, 1)) %>% 
  mutate(prev_pitch = ifelse(ab_id == prev_ab_id, lead(pitch_type, 1), NA)) %>% 
  select(-ab_id, -prev_ab_id) %>% 
  mutate(prev_pitch = case_when(prev_pitch  %in% c("FF", "FC", "SI") ~ "Fastball",
                                prev_pitch %in% c("SL", "CU", "KC", 
                                                  "SV", "ST", "CS") ~ "Breaking Ball",
                                prev_pitch  %in% c("CH", "FS") ~ "Off Speed")) %>% 
  mutate(zone = relevel(as.factor(zone), ref = 5))

rhp <- rhp %>% 
  mutate(prev_pitch = ifelse(is.na(prev_pitch), "None", prev_pitch)) %>% 
  mutate(Count = paste0(balls, "-", strikes)) %>% 
  mutate(Count = as.factor(Count))

sliders2 <- rhp %>% 
  filter(hitter == "R") %>% 
  filter(pitch_type == "SL") %>% 
  mutate(count = paste0(balls, "_", strikes),
         prev_pitch = as.factor(prev_pitch)) %>% 
  mutate(prev_pitch_ff = ifelse(prev_pitch == "FF", 1, 0))
  
fastballs2 <- rhp %>% 
  filter(hitter == "R") %>% 
  filter(pitch_type == fb_type) %>% 
  mutate(count = paste0(balls, "_", strikes),
         prev_pitch = as.factor(prev_pitch))

```

<br>

### **Predicted stat rates by batter**

```{r Barrel / Strike Variables, message = FALSE, warning = FALSE}

rhp <- rhp %>% 
  mutate(is_barrel = is.barrel(LA = launch_angle, EV = launch_speed)) %>% 
  mutate(is_strike = ifelse(description  %in% c("called_strike", "swinging_strike",
                                           "foul_tip", "bunt_foul_tip", "foul_bunt",
                                           "swinging_strike_blocked", "missed_bunt"),
                       1, 0))


# Batter Whiff
batter_stats <- rhp %>% 
  summarize(rate = mean(whiff),
                      pitches = n(),
            .by = c(batter, pitch_type)) %>% 
  mutate(pitch_whiff = weighted.mean(rate, pitches),
         .by = pitch_type) %>% 
  mutate(pred_bwhiff = (pitches / 300)*rate + ((300-pitches)/300)*pitch_whiff) %>% 
  mutate(pred_bwhiff = ifelse(pitches >= 300, rate, pred_bwhiff))


# Merging Whiff Prediction with RHP
rhp <- rhp %>% 
  left_join(select(batter_stats, batter, pitch_type, pred_bwhiff), 
             by = c("batter" = "batter", "pitch_type" = "pitch_type"))

rhp <- rhp %>% 
  mutate(prev_pitch = ifelse(is.na(prev_pitch), "None", prev_pitch)) %>% 
  mutate(Count = paste0(balls, "-", strikes)) %>% 
  mutate(Count = as.factor(Count))


# Barrel
batter_stats2 <- rhp %>% 
  summarize(rate = mean(is_barrel),
                      pitches = n(),
            .by = c(batter, pitch_type)) %>% 
  mutate(pitch_barrel = weighted.mean(rate, pitches),
         .by = pitch_type) %>% 
  mutate(pred_bbarrel = (pitches / 300)*rate + ((300-pitches)/300)*pitch_barrel) %>% 
  mutate(pred_bbarrel = ifelse(pitches >= 300, rate, pred_bbarrel))

rhp <- rhp %>% 
  left_join(select(batter_stats2, batter, pitch_type, pred_bbarrel), 
             by = c("batter" = "batter", "pitch_type" = "pitch_type"))


sliders3 <- rhp %>% 
  filter(hitter == "R") %>% 
  filter(pitch_type == "SL") %>% 
  mutate(count = paste0(balls, "_", strikes),
         prev_pitch = as.factor(prev_pitch)) %>% 
  mutate(prev_pitch_ff = ifelse(prev_pitch == "FF", 1, 0))
  
fastballs3 <- rhp %>% 
  filter(hitter == "R") %>% 
  filter(pitch_type == fb_type) %>% 
  mutate(count = paste0(balls, "_", strikes),
         prev_pitch = as.factor(prev_pitch))

```

<br>

### **Predicted whiff rate by batter**


#### WHIFF Slider Initial Model

```{r Slider Init Model Whiff, message = FALSE}
# Initial Model
sl_model_whiff_all <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              count + pfx_total + speed_change + break_change + distance + prev_pitch +
                speed_fb_diff + pfx_x_fb_diff + pfx_z_fb_diff + release_spin_rate +
                I(plate_x^2) + I(plate_z^2) + pred_bwhiff,
              data = sliders3, family = binomial)

# Model Evaluation
summary(sl_model_whiff_all)
```

#### WHIFF Slider Refined Model & Predictions

```{r Slider Refined Model Whiff, message = FALSE}
# Refined Model
sl_model_whiff <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              pfx_total + speed_change + break_change + distance + prev_pitch +
                speed_fb_diff + release_spin_rate +
                I(plate_z^2) + pred_bwhiff,
              data = sliders3, family = binomial)

# Model Evaluation
summary(sl_model_whiff)

# Model Predictions
sl_preds_whiff <- sliders3 %>% 
  mutate(prediction_log = predict(sl_model_whiff, sliders3),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

ggplot(sl_preds_whiff, aes(x = prediction, y = as.numeric(whiff))) +
  geom_point(alpha = 0.01) +
  geom_smooth() +
  geom_smooth(method = "lm") +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  theme_bw()

```


#### WHIFF Fastball Initial Model

```{r Fastball Init Model Whiff, message = FALSE}
# Initial Model
fb_model_whiff_all <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              count + pfx_total + speed_change + break_change + distance + prev_pitch +
                release_spin_rate + I(plate_x^2) + I(plate_z^2) + pred_bwhiff,
              data = fastballs3, family = binomial)

# Model Evaluation
summary(fb_model_whiff_all)
```

#### WHIFF Fastball Refined Model & Predictions

```{r Fastball Refined Model Whiff, message = FALSE}
# Refined Model
fb_model_whiff <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              pfx_total + speed_change + break_change + distance + prev_pitch +
                release_spin_rate + I(plate_x^2) + I(plate_z^2) + pred_bwhiff,
              data = fastballs3, family = binomial)

# Model Evaluation
summary(fb_model_whiff)

# Model Predictions
fb_preds_whiff <- fastballs3 %>% 
  mutate(prediction_log = predict(fb_model_whiff, fastballs3),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

ggplot(fb_preds_whiff, aes(x = prediction, y = as.numeric(whiff))) +
  geom_point(alpha = 0.01) +
  geom_smooth() +
  geom_smooth(method = "lm") +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  theme_bw()
```

<br>

### **Predicted barrel rate by batter**


#### BARREL Slider Initial Model

```{r Slider Init Model Barrel, message = FALSE}


# Initial Model
sl_model_barrel_all <- glm(is_barrel ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              count + pfx_total + speed_change + break_change + distance + prev_pitch +
                speed_fb_diff + pfx_x_fb_diff + pfx_z_fb_diff + release_spin_rate +
                I(plate_x^2) + I(plate_z^2) + pred_bbarrel,
              data = sliders3, family = binomial)

# Model Evaluation
summary(sl_model_barrel_all)
```

#### BARREL Slider Refined Model & Predictions

```{r Slider Refined Model Barrel, message = FALSE}
# Refined Model
sl_model_barrel <- glm(is_barrel ~ pitch_speed + plate_z + zone +
              prev_pitch + speed_fb_diff + I(plate_x^2) + I(plate_z^2) + pred_bbarrel,
              data = sliders3, family = binomial)

# Model Evaluation
summary(sl_model_barrel)

# Model Predictions
sl_preds_barrel <- sliders3 %>% 
  mutate(prediction_log = predict(sl_model_barrel, sliders3),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

ggplot(sl_preds_barrel, aes(x = prediction, y = as.numeric(is_barrel))) +
  geom_point(alpha = 0.01) +
  geom_smooth() +
  geom_smooth(method = "lm") +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  theme_bw()

```

#### BARREL Fastball Initial Model

```{r Fastball Init Model Barrel, message = FALSE}
# Initial Model
fb_model_barrel_all <- glm(is_barrel ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              count + pfx_total + speed_change + break_change + distance + prev_pitch +
                release_spin_rate + I(plate_x^2) + I(plate_z^2) + pred_bbarrel,
              data = fastballs3, family = binomial)

# Model Evaluation
summary(fb_model_barrel_all)
```

#### BARREL Fastball Refined Model & Predictions


```{r Fastball Refined Model Barrel, message = FALSE}
# Refined Model
fb_model_barrel <- glm(is_barrel ~ pitch_speed + pfx_z + plate_z + zone +
              break_change + prev_pitch +
                release_spin_rate + I(plate_x^2) + I(plate_z^2) + pred_bbarrel,
              data = fastballs3, family = binomial)

# Model Evaluation
summary(fb_model_barrel)

# Model Predictions
fb_preds_barrel <- fastballs3 %>% 
  mutate(prediction_log = predict(fb_model_barrel, fastballs3),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

ggplot(fb_preds_barrel, aes(x = prediction, y = as.numeric(is_barrel))) +
  geom_point(alpha = 0.01) +
  geom_smooth() +
  geom_smooth(method = "lm") +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  theme_bw()
```

<br>

### **Predicted strike rate by batter**


#### STRIKE Slider Initial Model

```{r Slider Init Model Strike, message = FALSE}
# Initial Model
sl_model_strike_all <- glm(is_strike ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              count + pfx_total + speed_change + break_change + distance + prev_pitch +
                speed_fb_diff + pfx_x_fb_diff + pfx_z_fb_diff + release_spin_rate +
                I(plate_x^2) + I(plate_z^2),
              data = sliders3, family = binomial)

# Model Evaluation
summary(sl_model_strike_all)
```

#### STRIKE Slider Refined Model & Predictions


```{r Slider Refined Model Strike, message = FALSE}
# Refined Model

sliders3 <- sliders3 %>% 
  mutate(fb_prev = ifelse(prev_pitch == "Fastball", 1, 0)) %>% 
  mutate(count_s = case_when(count  %in% c("0_0", "1_1", "2_2") ~ "Even",
                             count  %in%  c("1_0", "2_1", "2_0", "3_0", "3_1") ~ "Hitter",
                             count %in%  c("0_1", "0_2", "1_2") ~ "Pitcher",
                             count == "3_2" ~ "Full"))

sl_model_strike <- glm(is_strike ~ pfx_x + pfx_z + plate_x + plate_z + zone +
              count_s + pfx_total + break_change + distance + prev_pitch +
                speed_fb_diff + release_spin_rate +
                I(plate_x^2) + I(plate_z^2),
              data = sliders3, family = binomial)

# Model Evaluation
summary(sl_model_strike)

# Model Predictions
sl_preds_strike <- sliders3 %>% 
  mutate(prediction_log = predict(sl_model_strike, sliders3),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

ggplot(sl_preds_strike, aes(x = prediction, y = as.numeric(is_strike))) +
  geom_point(alpha = 0.01) +
  geom_smooth() +
  geom_smooth(method = "lm") +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  theme_bw()
```


#### STRIKE Fastball Initial Model

```{r Fastball Init Model Strike, message = FALSE}
# Initial Model
fb_model_strike_all <- glm(is_strike ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              count + pfx_total + speed_change + break_change + distance + prev_pitch +
                release_spin_rate + I(plate_x^2) + I(plate_z^2),
              data = fastballs3, family = binomial)

# Model Evaluation
summary(fb_model_strike_all)
```

#### STRIKE Fastball Refined Model & Predictions

```{r Fastball Refined Model Strike, message = FALSE}
# Refined Model

fb_model_strike <- glm(is_strike ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              count + pfx_total + break_change + distance + 
                release_spin_rate + I(plate_x^2) + I(plate_z^2),
              data = fastballs3, family = binomial)

# Model Evaluation
summary(fb_model_strike)

# Model Predictions
fb_preds_strike <- fastballs3 %>% 
  mutate(prediction_log = predict(fb_model_strike, fastballs3),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

ggplot(fb_preds_strike, aes(x = prediction, y = as.numeric(is_strike))) +
  geom_point(alpha = 0.01) +
  geom_smooth() +
  geom_smooth(method = "lm") +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  theme_bw()
```



#### Slider Initial Model

```{r Slider Init Model, message = FALSE}
# Initial Model
sl_model_all <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              count + pfx_total + speed_change + break_change + distance + 
                prev_pitch + speed_fb_diff + pfx_x_fb_diff + pfx_z_fb_diff + release_spin_rate +
                I(plate_x^2) + I(plate_z^2),
              data = sliders3, family = binomial)

# Model Evaluation
# summary(sl_model_all)
```

#### Slider Refined Model & Predictions

```{r Slider Refined Model, message = FALSE}
sl_model <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              pfx_total + speed_change + break_change + distance + release_spin_rate +
                prev_pitch + speed_fb_diff + I(plate_x^2) + I(plate_z^2),
              data = sliders3, family = binomial)
sl_model %>% summary

# Model Predictions
sl_preds <- sliders3 %>% 
  mutate(prediction_log = predict(sl_model, sliders3),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

sl_preds %>% 
  mutate(prediction = round(prediction, 2)) %>% 
  group_by(prediction) %>% 
  summarize(n = n(), whiff_rate = mean(whiff)) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = prediction, y = whiff_rate)) +
  geom_point(aes(size = n)) + # size of bin shown on graph
  coord_fixed() +
  geom_smooth(se = FALSE) +
  labs(y = "observed whiff proportion",
       x = "projected % whiff chance",
       title = "Slider Whiff Model Prediction",
       subtitle = "Whiff proportion by predicted whiff value",
       caption = "Whiff predictions have a 1% bin width")
```

#### Fastball Initial Model

```{r Fastball Init Model, message = FALSE}
# Initial Model
fb_model_all <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              count + pfx_total + speed_change + break_change + distance + release_spin_rate +
                prev_pitch + pitch_type + I(plate_x^2) + I(plate_z^2),
              data = fastballs3, family = binomial)

# Model Evaluation
# summary(fb_model_all)
```

#### Fastball Refined Model & Predictions

```{r Fastball Refined Model, message = FALSE}
fb_model <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              pfx_total + speed_change + break_change + release_spin_rate +
                pitch_type + I(plate_x^2) + I(plate_z^2),
              data = fastballs3, family = binomial)

fb_model %>% summary

# Model Predictions
fb_preds <- fastballs3 %>% 
  mutate(prediction_log = predict(fb_model, fastballs3),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction))

fb_preds %>% 
  mutate(prediction = round(prediction, 2)) %>% 
  group_by(prediction) %>% 
  summarize(n = n(), whiff_rate = mean(whiff)) %>% 
  as.data.frame() %>% 
  ggplot(aes(x = prediction, y = whiff_rate)) +
  geom_point(aes(size = n)) + # size of bin shown on graph
  coord_fixed() +
  geom_smooth(se = FALSE) +
  labs(y = "observed whiff proportion",
       x = "projected % whiff chance",
       title = "Fastball Whiff Model Prediction",
       subtitle = "Whiff proportion by predicted whiff value",
       caption = "Whiff predictions have a 1% bin width")
```

<br>

### **Making Naive Models**

```{r Naive Models}

## Intercept-Only Models

# Slider

sl_model_whiff_int <- glm(whiff ~ 1, 
                      data = sliders, family = binomial) 
sl_whiff_int <- augment(sl_model_whiff_int)


sl_whiff_int <- sl_whiff_int %>% 
  mutate(prediction_log = predict(sl_model_whiff_int, sl_whiff_int),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction)) %>% 
  mutate(Response = "whiff",
         pitch = "slider",
         type = "intercept only")


# Fastball

fb_model_whiff_int <- glm(whiff ~ 1, 
                      data = fastballs, family = binomial) 
fb_whiff_int <- augment(fb_model_whiff_int)


fb_whiff_int <- fb_whiff_int %>% 
  mutate(prediction_log = predict(fb_model_whiff_int, fb_whiff_int),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction)) %>% 
  mutate(Response = "whiff",
         pitch = "fastball",
         type = "intercept only")


## Zone-Only Models

# Slider

sl_model_whiff_zone <- glm(whiff ~ zone, 
                      data = sliders3, family = binomial) 

sl_whiff_zone <- augment(sl_model_whiff_zone)


sl_whiff_zone <- sl_whiff_zone %>% 
  mutate(prediction_log = predict(sl_model_whiff_zone, sl_whiff_zone),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction)) %>% 
  mutate(Response = "whiff",
         pitch = "slider",
         type = "zone only")


# Fastball

fb_model_whiff_zone <- glm(whiff ~ zone, 
                      data = fastballs3, family = binomial) 

fb_whiff_zone <- augment(fb_model_whiff_zone)


fb_whiff_zone <- fb_whiff_zone %>% 
  mutate(prediction_log = predict(fb_model_whiff_zone, fb_whiff_zone),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction)) %>% 
  mutate(Response = "whiff",
         pitch = "fastball",
         type = "zone only")


```

<br>

### **Combining All Models**


#### WHIFF Slider Refined Model & Predictions

```{r Slider Refined Model Whiff 2, message = FALSE}
# Refined Model
sl_model_whiff_final <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              pfx_total + speed_change + break_change + prev_pitch +
                speed_fb_diff + release_spin_rate +
                I(plate_z^2) + pred_bwhiff,
              data = sliders3, family = binomial)

# Model Evaluation
summary(sl_model_whiff_final)

sl_whiff <- augment(sl_model_whiff_final)
  
sl_whiff <- sl_whiff %>% 
  mutate(prediction_log = predict(sl_model_whiff_final, sl_whiff),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction)) %>% 
  mutate(Response = "whiff",
         pitch = "slider")

```


#### WHIFF Fastball Refined Model & Predictions


```{r Fastball Refined Model Whiff 2, message = FALSE}
# Refined Model
fb_model_whiff_final <- glm(whiff ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              pfx_total + speed_change + break_change + prev_pitch +
                release_spin_rate + I(plate_x^2) + I(plate_z^2) + pred_bwhiff,
              data = fastballs3, family = binomial)

# Model Evaluation
summary(fb_model_whiff_final)

fb_whiff <- augment(fb_model_whiff_final)
  
fb_whiff <- fb_whiff %>% 
  mutate(prediction_log = predict(fb_model_whiff_final, fb_whiff),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction)) %>% 
  mutate(Response = "whiff",
         pitch = "fastball")

```

#### BARREL Slider Refined Model & Predictions


```{r Slider Refined Model Barrel 2, message = FALSE}
# Refined Model
sl_model_barrel_final <- glm(is_barrel ~ pitch_speed + plate_z + plate_x +
              prev_pitch + speed_fb_diff + I(plate_x^2) + I(plate_z^2) + pred_bbarrel,
              data = sliders3, family = binomial)


# Model Evaluation
summary(sl_model_barrel_final)
sl_barrel <- augment(sl_model_barrel_final)
  
sl_barrel <- sl_barrel %>% 
  mutate(prediction_log = predict(sl_model_barrel_final, sl_barrel),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction)) %>% 
  mutate(Response = "barrel",
         pitch = "slider")

```


#### BARREL Fastball Refined Model & Predictions



```{r Fastball Refined Model Barrel 2, message = FALSE}
# Refined Model
fb_model_barrel_final <- glm(is_barrel ~ pitch_speed + pfx_z + plate_z + 
              break_change + prev_pitch + plate_x +
                release_spin_rate + I(plate_x^2) + I(plate_z^2) + pred_bbarrel,
              data = fastballs3, family = binomial)


# Model Evaluation
summary(fb_model_barrel_final)
fb_barrel <- augment(fb_model_barrel_final)
  
fb_barrel <- fb_barrel %>% 
  mutate(prediction_log = predict(fb_model_barrel_final, fb_barrel),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction)) %>% 
  mutate(Response = "barrel",
         pitch = "fastball")

# No Zone in Fastball?

summarize(fastballs3, b = mean(is_barrel), d = mean(distance), .by = zone) %>% 
  arrange(desc(b))

summarize(fastballs3, b = mean(is_barrel), d = mean(distance), .by = zone) %>% 
  arrange(desc(b)) %>% 
  with(cor(d, b))

```

#### STRIKE Slider Refined Model & Predictions



```{r Slider Refined Model Strike 2, message = FALSE}
# Refined Model

sliders3 <- sliders3 %>% 
  mutate(fb_prev = ifelse(prev_pitch == "Fastball", 1, 0)) %>% 
  mutate(count_s = case_when(count  %in% c("0_0", "1_1", "2_2") ~ "Even",
                             count  %in%  c("1_0", "2_1", "2_0", "3_0", "3_1") ~ "Hitter",
                             count %in%  c("0_1", "0_2", "1_2") ~ "Pitcher",
                             count == "3_2" ~ "Full"))

sl_model_strike_final <- glm(is_strike ~ pfx_x + pfx_z + plate_x + plate_z + zone +
              count_s + pfx_total + break_change + distance + prev_pitch +
                speed_fb_diff + release_spin_rate +
                I(plate_x^2) + I(plate_z^2),
              data = sliders3, family = binomial)

# Model Evaluation
summary(sl_model_strike_final)
sl_strike <- augment(sl_model_strike_final)
  
sl_strike <- sl_strike %>% 
  mutate(prediction_log = predict(sl_model_strike_final, sl_strike),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction)) %>% 
  mutate(Response = "strike",
         pitch = "slider")
```

#### STRIKE Fastball Refined Model & Predictions

```{r Fastball Refined Model Strike 2, message = FALSE}
# Refined Model

fb_model_strike_final <- glm(is_strike ~ pitch_speed + pfx_x + pfx_z + plate_x + plate_z + zone +
              count + pfx_total + break_change + distance + 
                release_spin_rate + I(plate_x^2) + I(plate_z^2),
              data = fastballs3, family = binomial)


# Model Evaluation
summary(fb_model_strike_final)
fb_strike <- augment(fb_model_strike_final)
  
fb_strike <- fb_strike %>% 
  mutate(prediction_log = predict(fb_model_strike_final, fb_strike),
         prediction = 1 / (1 + exp(-prediction_log)),
         rounded_pred = case_when(
           prediction >= 0.5 ~ 1,
           prediction < 0.5 ~ 0
         )) %>% 
  filter(!is.na(prediction)) %>% 
  mutate(Response = "strike",
         pitch = "fastball")

```


```{r Combining All Augmented/Predicted}

all_models_data <- bind_rows(
                    sl_whiff, fb_whiff,
                    sl_barrel, fb_barrel,
                    sl_strike, fb_strike,
                    sl_whiff_int, fb_whiff_int,
                    sl_whiff_zone, fb_whiff_zone) %>% 
  select(Response:pitch, type, whiff:pred_bwhiff, `I(plate_x^2)`:count, `.fitted`:rounded_pred)

all_models <- bind_rows(
  tidy(sl_model_whiff) %>% mutate(Response = "whiff", pitch = "slider", type = "complex"), 
  tidy(fb_model_whiff) %>% mutate(Response = "whiff", pitch = "fastball", type = "complex"),
  tidy(sl_model_barrel) %>% mutate(Response = "barrel", pitch = "slider", type = "complex"),
  tidy(fb_model_barrel) %>% mutate(Response = "barrel", pitch = "fastball", type = "complex"),
  tidy(sl_model_strike) %>% mutate(Response = "strike", pitch = "slider", type = "complex"),
  tidy(fb_model_strike) %>% mutate(Response = "strike", pitch = "fastball", type = "complex"),
  tidy(sl_model_whiff_int) %>% mutate(Response = "whiff", pitch = "slider", 
                                      type = "intercept only"),
  tidy(fb_model_whiff_int) %>% mutate(Response = "whiff", pitch = "fastball", 
                                      type = "intercept only"),
  tidy(sl_model_whiff_zone) %>% mutate(Response = "whiff", pitch = "slider", 
                                      type = "zone only"),
  tidy(fb_model_whiff_zone) %>% mutate(Response = "whiff", pitch = "fastball", 
                                      type = "zone only")
)

all_models_data$type <- all_models_data$type %>% 
  replace_na("complex")
```


```{r Comparing P-Values of Models}

# P-Value
all_models %>%
  filter(type == "complex") %>% 
  mutate(model_id = paste0(Response, pitch, type)) %>% 
  group_by(model_id) %>% 
  ggplot(aes(x = Response, y = term, fill = p.value)) +
  geom_tile() +
  facet_wrap(~ pitch) +
  scale_fill_gradient(limits = c(0, 0.05),
                      low = "green", high = "yellow", na.value = "lightgray") +
  theme_classic() +
  NULL



# Estimate
all_models %>%
  filter(type == "complex") %>% 
  mutate(model_id = paste0(Response, pitch, type)) %>% 
  group_by(model_id) %>% 
  ggplot(aes(x = Response, y = term, fill = estimate)) +
  geom_tile() +
  facet_wrap(~ pitch) +
  scale_fill_brewer(type = "div") +
  scale_fill_gradient2(low = "red", high = "green", mid = "white", midpoint = 0,
                       limits = c(-10, 10)) +
  theme_classic() +
  NULL


# Log Estimate
all_models %>%
  filter(type == "complex") %>% 
  mutate(log_estimate = log(abs(estimate))*(estimate/abs(estimate))) %>% 
  mutate(model_id = paste0(Response, pitch, type)) %>% 
  group_by(model_id) %>% 
  ggplot(aes(x = Response, y = term, fill = log_estimate)) +
  geom_tile() +
  facet_wrap(~ pitch) +
  scale_fill_brewer(type = "div") +
  scale_fill_gradient2(low = "red", high = "green", mid = "white", midpoint = 0) +
  theme_classic() +
  NULL
  

```

```{r}

# all_pitches %>% 
#   mutate(pitch_speed = round(pitch_speed, 0)) %>% 
#   group_by(p_throws, hitter, pitch_type, pitch_speed) %>% 
#   filter(!is.na(pfx_x)) %>% 
#   filter(!is.na(pfx_z)) %>% 
#   summarize(min_x = min(pfx_x), max_x = max(pfx_x),
#             min_z = min(pfx_z), max_z = max(pfx_z)) %>% 
#   write.csv("Movement.csv")


# write.csv(all_models, "models1.csv")
```



